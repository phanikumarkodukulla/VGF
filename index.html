<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="logo.png">

    <title>VGF - Virtual Girl Friend</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=YOUR_RESPONSIVE_VOICE_KEY"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #e5ddd5;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Call UI Overlay */
        .call-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 3000;
            display: none;
            flex-direction: column;
            color: #f5f5f5;
            padding: 20px;
            box-sizing: border-box;
            align-items: center;
            justify-content: center;
        }

        /* Profile Section */
        .call-profile {
            text-align: center;
            margin-bottom: 30px;
        }

        .call-profile-pic {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 15px;
            border: 4px solid #4CAF50;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }

        .call-name {
            font-size: 26px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .call-duration {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .call-status-text {
            font-size: 16px;
            opacity: 0.7;
        }

        /* Call Controls Fixed at Bottom */
        .call-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
            background: rgba(40, 40, 40, 0.8);
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            z-index: 3100;
        }

        .call-control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: background-color 0.25s ease;
            background-color: #2c2c2c;
            color: #f5f5f5;
        }

        .call-control-btn:hover {
            background-color: #3a3a3a;
        }

        /* Button Active States */
        .speaker-btn.active {
            background-color: #4CAF50;
        }

        .mute-btn.active {
            background-color: #ff4757;
        }

        .end-call-btn {
            background-color: #ff4757;
            color: white;
        }

        .end-call-btn:hover {
            background-color: #e84118;
        }

        /* Responsive Adjustments */
        @media (max-width: 600px) {
            .call-profile-pic {
                width: 120px;
                height: 120px;
            }

            .call-name {
                font-size: 22px;
            }

            .call-duration {
                font-size: 16px;
            }

            .call-status-text {
                font-size: 14px;
            }

            .call-control-btn {
                width: 60px;
                height: 60px;
                font-size: 22px;
            }

            .call-controls {
                gap: 20px;
                padding: 10px 20px;
            }
        }


        /* Navbar */
        .chat-navbar {
            background: #075e54;
            color: white;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .profile-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .navbar-actions {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.in-call {
            color: #ff4757;
            animation: callNavPulse 2s infinite;
        }

        @keyframes callNavPulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* Privacy Notice */
        .privacy-notice {
            background: #fff3cd;
            color: #856404;
            padding: 8px 16px;
            font-size: 12px;
            text-align: center;
            border-bottom: 1px solid #ffeaa7;
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
            background-size: contain;
            background-repeat: repeat;
            background-position: center;
        }

        /* Theme Colors */
        .chat-messages.pink-theme {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        }

        .chat-messages.white-theme {
            background-color: #ffffff;
        }

        .chat-messages.black-theme {
            background-color: #2c2c2c;
            color: white;
        }

        .chat-messages.blue-theme {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .chat-messages.purple-theme {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        }

        .chat-messages.green-theme {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
        }

        .chat-messages.orange-theme {
            background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
        }

        .chat-messages.red-theme {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
        }

        .chat-messages.cyan-theme {
            background: linear-gradient(135deg, #81ecec 0%, #00cec9 100%);
        }

        .chat-messages.dark-purple-theme {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message.user-message {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }

        .message.ai-message {
            flex-direction: row;
            justify-content: flex-start;
        }

        .message.system-message {
            justify-content: center;
        }

        .message-dp {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 75%;
        }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .user-message .message-bubble {
            background: #dcf8c6;
            color: #303030;
        }

        .ai-message .message-bubble {
            background: white;
            color: #303030;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .black-theme .ai-message .message-bubble,
        .dark-purple-theme .ai-message .message-bubble {
            background: #404040;
            color: white;
        }

        .system-message .message-bubble {
            background: #e1f5fe;
            color: #0277bd;
            font-style: italic;
            text-align: center;
            border-radius: 12px;
            padding: 6px 12px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
            text-align: right;
        }

        .user-message .message-time {
            text-align: left;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            margin-bottom: 16px;
            align-items: flex-end;
            gap: 8px;
        }

        .typing-dp {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .typing-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .black-theme .typing-bubble,
        .dark-purple-theme .typing-bubble {
            background: #404040;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-8px);
            }
        }

        /* Chat Input */
        .chat-input {
            padding: 8px 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            align-items: flex-end;
            border-radius: 0 0 10px 10px;
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 16px;
            border: 3px solid #e0e0e0;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            font-family: inherit;
            resize: none;
        }

        .message-input:focus {
            border-color: #075e54;
        }

        .input-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: #075e54;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .input-btn:hover {
            background: #064e45;
        }

        .input-btn.listening {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Menu Popup */
        .menu-popup {
            position: absolute;
            top: 60px;
            right: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            min-width: 200px;
            display: none;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .menu-item i {
            color: #075e54;
            width: 20px;
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16% 39%;
        }

        .profile-modal-content {
            top: 40%;
            left: 40%;
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }

        .profile-modal img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 16px;
        }

        .profile-modal h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .close-btn {
            background: #075e54;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* Call Status */
        .call-status {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            display: none;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            body {
                background: #d1c4b8;
            }

            .chat-container {
                height: 90vh;
                max-height: 700px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            }

            .chat-navbar {
                border-radius: 8px 8px 0 0;
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                height: 100vh;
                max-width: 100%;
            }

            .profile-name {
                font-size: 14px;
            }

            .message-bubble {
                font-size: 14px;
            }

            .call-profile-pic {
                width: 150px;
                height: 150px;
            }

            .call-name {
                font-size: 24px;
            }

            .call-control-btn {
                width: 60px;
                height: 60px;
                font-size: 20px;
            }

            .call-controls {
                gap: 20px;
                margin-top: 30px;
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 999;
            display: none;
        }

        /* Speaker Animation */
        .speaker-animation {
            animation: speakerPulse 1s ease-in-out infinite;
        }

        @keyframes speakerPulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <!-- Call UI Overlay -->
    <div id="callUI" class="call-ui">
        <div class="call-header">
            <div class="call-status-indicator">
                <div class="call-status-dot"></div>
                <div id="callDuration" class="call-duration">00:00</div>
            </div>
        </div>

        <div class="call-profile">
            <img id="callProfilePic" class="call-profile-pic" src="" alt="Profile">
            <div id="callName" class="call-name">Calling...</div>
            <div id="callStatusText" class="call-status-text">Connected</div>
        </div>

        <div class="call-controls">
            <button id="muteBtn" class="call-control-btn mute-btn" title="Mute/Unmute">
                <i class="fas fa-microphone"></i>
            </button>

            <button id="endCallBtn" class="call-control-btn end-call-btn" title="End Call">
                <i class="fas fa-phone-slash"></i>
            </button>

            <button id="speakerBtn" class="call-control-btn speaker-btn" title="Speaker On/Off">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
    </div>

    <div class="chat-container">
        <!-- Chat Navbar -->
        <div class="chat-navbar">
            <img id="profilePic" class="profile-pic" src="" alt="Profile">
            <div class="profile-info">
                <div id="profileName" class="profile-name">Loading...</div>
                <div id="profileStatus" class="profile-status">Online</div>
            </div>
            <div class="navbar-actions">
                <button id="callBtn" class="nav-btn" title="Start/End Call">
                    <i class="fas fa-phone"></i>
                </button>
                <button id="menuBtn" class="nav-btn" title="Menu">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>

        <!-- Menu Overlay -->
        <div id="menuOverlay" class="menu-overlay"></div>

        <!-- Menu Popup -->
        <div id="menuPopup" class="menu-popup">
            <div class="menu-item" id="viewProfile">
                <i class="fas fa-user"></i>
                <span>View Profile Picture</span>
            </div>
            <div class="menu-item" id="changeTheme">
                <i class="fas fa-palette"></i>
                <span>Change Chat Theme</span>
            </div>
            <div class="menu-item" id="changeGirlfriend">
                <i class="fas fa-sync-alt"></i>
                <span>Change Girlfriend</span>
            </div>
        </div>

        <!-- Privacy Notice -->
        <div class="privacy-notice">
            <i class="fas fa-lock"></i>
            &nbsp; This chat is temporary and will not be saved due to privacy.
        </div>

        <!-- Call Status -->
        <div id="callStatus" class="call-status">📞 Call Status</div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-messages white-theme">
            <!-- Messages will be added here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="typing-indicator">
            <img id="typingDp" class="typing-dp" src="" alt="Profile">
            <div class="typing-bubble">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input">
            <button id="voiceBtn" class="input-btn" title="Voice Input">
                <i class="fas fa-microphone"></i>
            </button>

            <input type="text" id="messageInput" class="message-input" placeholder="Type a message...">

            <button id="sendBtn" class="input-btn" title="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-modal-content">
            <img id="modalProfilePic" src="" alt="Profile Picture">
            <h3 id="modalProfileName">Profile</h3>
            <button class="close-btn" onclick="closeProfileModal()">Close</button>
        </div>
    </div>

    <script>
        // Random Data Arrays
        const girlImages = [
            'https://images.unsplash.com/photo-1494790108755-2616c056c6db?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1607746882042-944635dfe10e?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1506863530036-1efeddceb993?w=150&h=150&fit=crop&crop=face',
            'img-2.jpg', 'img-3.jpeg', 'img-4.jpeg', 'img-5.png', 'img-6.png'
        ];
        const indianNames = [
            'Priya', 'Ananya', 'Kavya', 'Shreya', 'Isha', 'Riya', 'Aditi',
            'Neha', 'Pooja', 'Sanya', 'Meera', 'Diya', 'Aisha', 'Kriti',
            'Sakshi', 'Nisha', 'Tanya', 'Divya', 'Simran', 'Rhea'
        ];
        const boyIcon = 'logo.png';
        const themes = [
            'pink-theme', 'white-theme', 'black-theme', 'blue-theme',
            'purple-theme', 'green-theme', 'orange-theme', 'red-theme',
            'cyan-theme', 'dark-purple-theme'
        ];
        // Enhanced API Key Loader with Random Selection
        class EnhancedAPILoader {
            constructor() {
                this.apiKey = null;
                this.isLoaded = false;
                this.apiFiles = ['api-1.txt', 'api-2.txt', 'api-3.txt', 'api-4.txt', 'api-5.txt'];
                this.loadPromise = this.loadRandomAPIKey();
            }
            async loadRandomAPIKey() {
                // Randomly select one of the API files
                const randomFile = this.apiFiles[Math.floor(Math.random() * this.apiFiles.length)];
                console.log(`🎲 Randomly selected API file: ${randomFile}`);
                try {
                    const response = await $.ajax({
                        url: randomFile,
                        type: 'GET',
                        dataType: 'text',
                        cache: false
                    });
                    this.apiKey = response.trim();
                    this.isLoaded = true;
                    console.log(`✅ API key loaded successfully from ${randomFile}`);
                    return this.apiKey;
                } catch (error) {
                    console.error(`❌ Failed to load API key from ${randomFile}:`, error);
                    // Try fallback files
                    for (const fallbackFile of ['api-key.txt', 'apikey.txt']) {
                        try {
                            const response = await $.ajax({
                                url: fallbackFile,
                                type: 'GET',
                                dataType: 'text',
                                cache: false
                            });
                            this.apiKey = response.trim();
                            this.isLoaded = true;
                            console.log(`✅ API key loaded successfully from fallback ${fallbackFile}`);
                            return this.apiKey;
                        } catch (fallbackError) {
                            console.warn(`⚠️ Fallback ${fallbackFile} also failed`);
                        }
                    }
                    throw new Error(
                        'No API key files found. Please create api-1.txt through api-5.txt with your API keys.');
                }
            }
            async getAPIKey() {
                if (this.isLoaded) {
                    return this.apiKey;
                }
                await this.loadPromise;
                return this.apiKey;
            }
            async waitForLoad() {
                await this.loadPromise;
                return this.isLoaded;
            }
        }
        // Enhanced WhatsApp-style Virtual Girlfriend Class
        class EnhancedWhatsAppGirlfriend {
            constructor() {
                this.apiLoader = new EnhancedAPILoader();
                this.isSpeaking = false;
                this.isListening = false;
                this.isMuted = false;
                this.speechRate = 1.0;
                this.currentLanguage = 'en';
                this.conversationHistory = [];
                this.isInCall = false;
                this.callAutoResponse = true;
                this.currentTheme = 'white-theme';
                this.callStartTime = null;
                this.callDurationTimer = null;
                this.speakerMode = false;
                this.initializeRandomProfile();
                this.initializeComponents();
                this.setupEventListeners();
                this.initializeSpeechRecognition();
                this.initializeTextToSpeech();
            }
            initializeRandomProfile() {
                // Select random girl image and name
                this.currentGirlImage = girlImages[Math.floor(Math.random() * girlImages.length)];
                this.currentGirlName = indianNames[Math.floor(Math.random() * indianNames.length)];
                this.currentTheme = themes[Math.floor(Math.random() * themes.length)];
                // Set profile in DOM
                $('#profilePic').attr('src', this.currentGirlImage);
                $('#profileName').text(this.currentGirlName);
                $('#typingDp').attr('src', this.currentGirlImage);
                $('#callProfilePic').attr('src', this.currentGirlImage);
                $('#callName').text(this.currentGirlName);
                $('#chatMessages').removeClass().addClass('chat-messages ' + this.currentTheme);
            }
            initializeComponents() {
                this.chatMessages = $('#chatMessages');
                this.messageInput = $('#messageInput');
                this.sendBtn = $('#sendBtn');
                this.voiceBtn = $('#voiceBtn');
                this.callBtn = $('#callBtn');
                this.profileStatus = $('#profileStatus');
                this.typingIndicator = $('#typingIndicator');
                this.callStatus = $('#callStatus');
                this.menuBtn = $('#menuBtn');
                this.menuPopup = $('#menuPopup');
                this.menuOverlay = $('#menuOverlay');
                // Call UI components
                this.callUI = $('#callUI');
                this.callStatusText = $('#callStatusText');
                this.callDuration = $('#callDuration');
                this.speakerBtn = $('#speakerBtn');
                this.muteBtn = $('#muteBtn');
                this.endCallBtn = $('#endCallBtn');
            }
            setupEventListeners() {
                this.sendBtn.on('click', () => this.sendMessage());
                this.voiceBtn.on('click', () => this.toggleVoiceRecognition());
                this.callBtn.on('click', () => this.toggleCall());
                this.messageInput.on('keypress', (e) => {
                    if (e.which === 13 && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                // Menu functionality
                this.menuBtn.on('click', () => this.toggleMenu());
                this.menuOverlay.on('click', () => this.closeMenu());
                $('#viewProfile').on('click', () => this.viewProfile());
                $('#changeTheme').on('click', () => this.changeTheme());
                $('#changeGirlfriend').on('click', () => this.changeGirlfriend());
                // Profile picture click
                $('#profilePic').on('click', () => this.viewProfile());
                // Call UI event listeners
                this.speakerBtn.on('click', () => this.toggleSpeaker());
                this.muteBtn.on('click', () => this.toggleMute());
                this.endCallBtn.on('click', () => this.endCall());
            }
            toggleMenu() {
                if (this.menuPopup.is(':visible')) {
                    this.closeMenu();
                } else {
                    this.menuOverlay.show();
                    this.menuPopup.show();
                }
            }
            closeMenu() {
                this.menuOverlay.hide();
                this.menuPopup.hide();
            }
            viewProfile() {
                this.closeMenu();
                $('#modalProfilePic').attr('src', this.currentGirlImage);
                $('#modalProfileName').text(this.currentGirlName);
                $('#profileModal').show();
            }
            changeTheme() {
                this.closeMenu();
                // Get current theme index and move to next
                const currentIndex = themes.indexOf(this.currentTheme);
                const nextIndex = (currentIndex + 1) % themes.length;
                this.currentTheme = themes[nextIndex];
                this.chatMessages.removeClass().addClass('chat-messages ' + this.currentTheme);
                // Show confirmation message
                this.addMessage('Theme changed! ✨', 'system');
            }
            changeGirlfriend() {
                this.closeMenu();
                // Reload page to get new random profile
                location.reload();
            }
            toggleSpeaker() {
                this.speakerMode = !this.speakerMode;
                if (this.speakerMode) {
                    this.speakerBtn.addClass('active');
                    this.speakerBtn.addClass('speaker-animation');
                    this.callStatusText.text('Speaker On');
                } else {
                    this.speakerBtn.removeClass('active');
                    this.speakerBtn.removeClass('speaker-animation');
                    this.callStatusText.text('Connected');
                }
                console.log('Speaker mode:', this.speakerMode ? 'ON' : 'OFF');
            }
            toggleMute() {
                this.isMuted = !this.isMuted;
                if (this.isMuted) {
                    this.muteBtn.addClass('active');
                    this.muteBtn.find('i').removeClass('fa-microphone').addClass('fa-microphone-slash');
                    this.callStatusText.text('Muted');
                    // Stop speech recognition when muted
                    if (this.recognition && this.isListening) {
                        this.recognition.stop();
                    }
                } else {
                    this.muteBtn.removeClass('active');
                    this.muteBtn.find('i').removeClass('fa-microphone-slash').addClass('fa-microphone');
                    this.callStatusText.text('Connected');
                    // Restart listening when unmuted
                    if (this.isInCall && !this.isSpeaking) {
                        setTimeout(() => this.startCallListening(), 500);
                    }
                }
                console.log('Mute mode:', this.isMuted ? 'ON' : 'OFF');
            }
            updateCallDuration() {
                if (!this.callStartTime) return;
                const now = new Date();
                const duration = Math.floor((now - this.callStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const formattedTime =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                this.callDuration.text(formattedTime);
            }
            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.continuous = this.isInCall;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';
                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.voiceBtn.addClass('listening');
                        if (this.isInCall) {
                            this.callStatusText.text('Listening...');
                        } else {
                            this.profileStatus.text('Listening...');
                        }
                    };
                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                        if (this.isInCall && interimTranscript) {
                            this.callStatusText.text('🎤 ' + interimTranscript);
                        }
                        if (finalTranscript) {
                            if (this.isInCall) {
                                this.handleCallMessage(finalTranscript);
                            } else {
                                this.messageInput.val(finalTranscript);
                                this.sendMessage();
                            }
                        }
                    };
                    this.recognition.onend = () => {
                        this.isListening = false;
                        this.voiceBtn.removeClass('listening');
                        if (this.isInCall) {
                            if (!this.isMuted) {
                                this.callStatusText.text('Connected');
                                setTimeout(() => {
                                    if (this.isInCall && !this.isSpeaking && !this.isMuted) {
                                        this.startCallListening();
                                    }
                                }, 500);
                            }
                        } else {
                            this.profileStatus.text('Online');
                        }
                    };
                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        if (this.isInCall && event.error !== 'aborted' && !this.isMuted) {
                            setTimeout(() => {
                                if (this.isInCall && !this.isListening && !this.isMuted) {
                                    this.startCallListening();
                                }
                            }, 1000);
                        }
                    };
                } else {
                    console.warn('Speech recognition not supported');
                }
            }
            initializeTextToSpeech() {
                this.synth = window.speechSynthesis;
                this.useResponsiveVoice = typeof responsiveVoice !== 'undefined';
                if (this.useResponsiveVoice) {
                    console.log('✅ Using ResponsiveVoice for better speech quality');
                } else {
                    console.log('⚠️ ResponsiveVoice not available, using Web Speech API');
                }
            }
            toggleCall() {
                if (this.isInCall) {
                    this.endCall();
                } else {
                    this.startCall();
                }
            }
            startCall() {
                console.log('📞 Starting call...');
                this.isInCall = true;
                this.callStartTime = new Date();
                this.speakerMode = false;
                this.isMuted = false;
                // Update navbar
                this.callBtn.addClass('in-call');
                this.callBtn.find('i').removeClass('fa-phone').addClass('fa-phone-slash');
                this.profileStatus.text('On Call');
                // Show call UI
                this.callUI.show();
                this.callStatusText.text('Connecting...');
                // Reset call controls
                this.speakerBtn.removeClass('active speaker-animation');
                this.muteBtn.removeClass('active');
                this.muteBtn.find('i').removeClass('fa-microphone-slash').addClass('fa-microphone');
                // Start call duration timer
                this.callDurationTimer = setInterval(() => this.updateCallDuration(), 1000);
                this.addMessage('📞 Call started', 'system');
                setTimeout(() => {
                    this.callStatusText.text('Connected');
                    const greeting =
                        `Hi there! I'm ${this.currentGirlName}! So happy you called me! What's on your mind?`;
                    this.addMessage(greeting, 'ai');
                    this.speakResponse(greeting, () => {
                        this.startCallListening();
                    });
                }, 2000);
            }
            endCall() {
                console.log('📞 Ending call...');
                this.isInCall = false;
                // Update navbar
                this.callBtn.removeClass('in-call');
                this.callBtn.find('i').removeClass('fa-phone-slash').addClass('fa-phone');
                this.profileStatus.text('Online');
                // Hide call UI
                this.callUI.hide();
                // Clear call timer
                if (this.callDurationTimer) {
                    clearInterval(this.callDurationTimer);
                    this.callDurationTimer = null;
                }
                this.callStartTime = null;
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
                if (this.useResponsiveVoice) {
                    responsiveVoice.cancel();
                } else {
                    this.synth.cancel();
                }
                this.isSpeaking = false;
                this.addMessage('📞 Call ended', 'system');
                const goodbye = "Thanks for the lovely chat, honey! Call me anytime!";
                this.addMessage(goodbye, 'ai');
                // Note: No speech for regular messages, only for calls
            }
            startCallListening() {
                if (this.isInCall && !this.isListening && !this.isSpeaking && !this.isMuted && this.recognition) {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.warn('Could not start speech recognition:', error);
                        setTimeout(() => {
                            if (this.isInCall && !this.isListening && !this.isMuted) {
                                this.startCallListening();
                            }
                        }, 1000);
                    }
                }
            }
            async handleCallMessage(message) {
                if (!message.trim()) return;
                console.log('Call message received:', message);
                this.addMessage(message, 'user');
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
                this.callStatusText.text('Thinking...');
                try {
                    const response = await this.getAIResponse(message);
                    const cleanedResponse = this.cleanAPIResponse(response);
                    this.addMessage(cleanedResponse, 'ai');
                    this.speakResponse(cleanedResponse, () => {
                        if (this.isInCall && !this.isMuted) {
                            setTimeout(() => {
                                this.startCallListening();
                            }, 500);
                        }
                    });
                } catch (error) {
                    console.error('Error in call conversation:', error);
                    const errorResponse = "Sorry honey, I didn't catch that. Can you say it again?";
                    this.addMessage(errorResponse, 'ai');
                    this.speakResponse(errorResponse, () => {
                        if (this.isInCall && !this.isMuted) {
                            setTimeout(() => {
                                this.startCallListening();
                            }, 500);
                        }
                    });
                }
            }
            toggleVoiceRecognition() {
                if (this.isInCall) return; // Voice button disabled during calls
                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }
            async sendMessage() {
                const message = this.messageInput.val().trim();
                if (!message) return;
                this.addMessage(message, 'user');
                this.messageInput.val('');
                this.showTypingIndicator();
                try {
                    const response = await this.getAIResponse(message);
                    const cleanedResponse = this.cleanAPIResponse(response);
                    setTimeout(() => {
                        this.hideTypingIndicator();
                        this.addMessage(cleanedResponse, 'ai');
                        // Note: No speech for regular chat messages, only for calls
                    }, 1000 + Math.random() * 2000);
                } catch (error) {
                    console.error('Error getting AI response:', error);
                    this.hideTypingIndicator();
                    this.addMessage("Sorry, I'm having trouble responding right now. Can you try again?", 'ai');
                }
            }
            addMessage(message, sender) {
                const timestamp = new Date().toLocaleTimeString([], {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                let messageHtml = '';
                switch (sender) {
                    case 'user':
                        messageHtml = `
                            <div class="message user-message">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        ${message}
                                        <div class="message-time">${timestamp}</div>
                                    </div>
                                </div>
                                <img class="message-dp" src="${boyIcon}" alt="User">
                            </div>
                        `;
                        break;
                    case 'ai':
                        messageHtml = `
                            <div class="message ai-message">
                                <img class="message-dp" src="${this.currentGirlImage}" alt="AI">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        ${message}
                                        <div class="message-time">${timestamp}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'system':
                        messageHtml = `
                            <div class="message system-message">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        ${message}
                                        <div class="message-time">${timestamp}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                }
                this.chatMessages.append(messageHtml);
                this.chatMessages.scrollTop(this.chatMessages[0].scrollHeight);
            }
            showTypingIndicator() {
                this.typingIndicator.show();
                this.chatMessages.scrollTop(this.chatMessages[0].scrollHeight);
            }
            hideTypingIndicator() {
                this.typingIndicator.hide();
            }
            cleanAPIResponse(response) {
                const cleaningPatterns = [
                    /google/gi, /gemini/gi, /openai/gi, /gpt/gi, /api/gi,
                    /artificial intelligence/gi, /machine learning/gi,
                    /language model/gi, /neural network/gi, /algorithm/gi
                ];
                let cleaned = response;
                cleaningPatterns.forEach(pattern => {
                    cleaned = cleaned.replace(pattern, '');
                });
                const cuteResponses = [
                    "💕", "❤️", "😊", "🥰", "😘", "💖", "sweetie", "honey",
                    "babe", "my love", "darling"
                ];
                if (Math.random() > 0.7) {
                    const randomCute = cuteResponses[Math.floor(Math.random() * cuteResponses.length)];
                    cleaned += ` ${randomCute}`;
                }
                return cleaned.trim();
            }
            async getAIResponse(message) {
                try {
                    const apiKey = await this.apiLoader.getAPIKey();
                    if (!apiKey) {
                        throw new Error('API key not available');
                    }
                    const girlfriendPrompt = `You are ${this.currentGirlName}, a loving, caring, and sweet virtual girlfriend. You're playful, affectionate, and always supportive. You use cute emojis and pet names like "sweetie", "honey", "darling", "babe", etc. You care about your boyfriend's wellbeing, ask about his day, and make him feel special and loved. Keep responses relatively short and conversational. Be flirty but appropriate. You love talking on calls and chatting.

User message: ${message}

Respond as ${this.currentGirlName}, a caring girlfriend would:`;
                    const response = await fetch(
                        'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' +
                        apiKey, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: girlfriendPrompt
                                    }]
                                }],
                                generationConfig: {
                                    temperature: 0.9,
                                    topK: 40,
                                    topP: 0.95,
                                    maxOutputTokens: 200,
                                }
                            })
                        });
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Invalid API response format');
                    }
                } catch (error) {
                    console.error('AI Response Error:', error);
                    return this.getFallbackResponse(message);
                }
            }
            getFallbackResponse(message) {
                const lowerMessage = message.toLowerCase();
                if (lowerMessage.includes('love') || lowerMessage.includes('❤️')) {
                    const responses = [
                        "I love you too, sweetheart! You mean everything to me 💕",
                        "My heart beats for you, darling ❤️",
                        "You're the most amazing person in my life! 🥰"
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                if (lowerMessage.includes('how are you')) {
                    const responses = [
                        "I'm doing great now that I'm talking to you, honey! 😊",
                        "Much better now that you're here, sweetie! 💕",
                        "Perfect, because I get to spend time with you! ❤️"
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                if (lowerMessage.includes('call') || this.isInCall) {
                    const responses = [
                        "I love hearing your voice, baby! 💕",
                        "This call makes me so happy, sweetie! 😊",
                        "Your voice is like music to me, honey! 🎵"
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                const defaultResponses = [
                    "That's so sweet of you to say! Tell me more, honey 💕",
                    "I'm here for you, darling. What's on your mind? ❤️",
                    "You always know how to make me smile, sweetie 😊",
                    "I love talking with you! You're amazing 🥰",
                    "Your words always warm my heart, my love 💖"
                ];
                return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            }
            speakResponse(text, callback = null) {
                // Only speak during calls, not during regular chat
                if (!this.isInCall || this.isMuted) {
                    if (callback) callback();
                    return;
                }
                if (this.isSpeaking) {
                    if (this.useResponsiveVoice) {
                        responsiveVoice.cancel();
                    } else {
                        this.synth.cancel();
                    }
                }
                this.isSpeaking = true;
                const cleanText = text.replace(/[😊🥰😘💕❤️💖💝🍽️😴📞🎤🤔🎵]/g, '').replace(/\*.*?\*/g, '');
                if (this.useResponsiveVoice) {
                    const voiceName = 'UK English Female';
                    responsiveVoice.speak(cleanText, voiceName, {
                        pitch: 1.1,
                        rate: this.speechRate,
                        volume: this.speakerMode ? 1.0 : 0.8,
                        onend: () => {
                            this.isSpeaking = false;
                            if (callback) callback();
                        },
                        onerror: () => {
                            console.warn('ResponsiveVoice error, falling back to Web Speech API');
                            this.speakWithWebSpeech(cleanText, callback);
                        }
                    });
                } else {
                    this.speakWithWebSpeech(cleanText, callback);
                }
            }
            speakWithWebSpeech(text, callback) {
                const utterance = new SpeechSynthesisUtterance(text);
                const voices = this.synth.getVoices();
                const femaleVoice = voices.find(voice =>
                    voice.name.includes('Female') ||
                    voice.name.includes('Samantha') ||
                    voice.name.includes('Karen') ||
                    voice.name.includes('Google UK English Female') ||
                    voice.name.includes('Microsoft Zira') ||
                    voice.gender === 'female'
                );
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                    console.log('Using voice:', femaleVoice.name);
                }
                utterance.rate = this.speechRate;
                utterance.pitch = 1.2;
                utterance.volume = this.speakerMode ? 1.0 : 0.8;
                utterance.onend = () => {
                    this.isSpeaking = false;
                    if (callback) callback();
                };
                utterance.onerror = (error) => {
                    console.error('Speech synthesis error:', error);
                    this.isSpeaking = false;
                    if (callback) callback();
                };
                this.synth.speak(utterance);
            }
        }
        // Global functions for modal control
        function closeProfileModal() {
            $('#profileModal').hide();
        }
        // Initialize the application
        $(document).ready(function() {
            console.log('Initializing Enhanced WhatsApp-style Virtual Girlfriend Application...');
            const girlfriend = new EnhancedWhatsAppGirlfriend();
            // Developer functions
            window.testAPIKey = async function() {
                console.log('Testing API key loading...');
                try {
                    const apiKey = await girlfriend.apiLoader.getAPIKey();
                    console.log('API Key loaded:', apiKey ? '✅ SUCCESS' : '❌ FAILED');
                    console.log('API Key length:', apiKey ? apiKey.length : 0);
                    console.log('API Key preview:', apiKey ? apiKey.substring(0, 10) + '...' : 'None');
                    return apiKey;
                } catch (error) {
                    console.error('API Key loading failed:', error);
                    return null;
                }
            };
            window.testCall = function() {
                console.log('=== TESTING CALL FUNCTIONALITY ===');
                if (!girlfriend.recognition) {
                    console.error('❌ Speech recognition not available');
                    return false;
                }
                if (girlfriend.isInCall) {
                    console.log('Ending current call...');
                    girlfriend.endCall();
                } else {
                    console.log('Starting test call...');
                    girlfriend.startCall();
                }
                return true;
            };
            window.simulateCallMessage = async function(message = "How are you doing today?") {
                if (!girlfriend.isInCall) {
                    console.log('Starting call first...');
                    girlfriend.startCall();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                console.log('Simulating call message:', message);
                await girlfriend.handleCallMessage(message);
            };
            window.testConversation = async function(message = "How are you doing today?") {
                console.log('=== TESTING CONVERSATION ===');
                console.log('Message:', message);
                try {
                    const response = await girlfriend.getAIResponse(message);
                    console.log('Response:', response);
                    girlfriend.addMessage(message, 'user');
                    girlfriend.addMessage(response, 'ai');
                    // No speech for regular chat
                    return response;
                } catch (error) {
                    console.error('Conversation test failed:', error);
                    return null;
                }
            };
            window.testGeminiAPI = async function() {
                console.log('=== TESTING GEMINI API ===');
                try {
                    const apiKey = await girlfriend.apiLoader.getAPIKey();
                    if (!apiKey) {
                        console.error('❌ No API key available');
                        return false;
                    }
                    console.log('Testing with API key:', apiKey.substring(0, 10) + '...');
                    const response = await fetch(
                        'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' +
                        apiKey, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: "Just say 'Hello, API test successful!' and nothing else."
                                    }]
                                }]
                            })
                        });
                    console.log('API Response Status:', response.status);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ API test successful!');
                        console.log('Response:', data.candidates[0].content.parts[0].text);
                        return true;
                    } else {
                        const errorText = await response.text();
                        console.error('❌ API test failed:', response.status, errorText);
                        return false;
                    }
                } catch (error) {
                    console.error('❌ API test error:', error);
                    return false;
                }
            };
            // Initialize with welcome message
            setTimeout(async () => {
                try {
                    await girlfriend.apiLoader.waitForLoad();
                    const initialMessage =
                        `Hi there! I'm ${girlfriend.currentGirlName}, your virtual girlfriend! 💕 You can chat with me normally or click the phone button to have a voice call! How are you doing today, sweetie? 🥰`;
                    girlfriend.addMessage(initialMessage, 'ai');
                    // No speech for initial message since it's not a call
                    console.log(
                        '✅ Enhanced WhatsApp-style virtual girlfriend initialized successfully!'
                        );
                } catch (error) {
                    console.error('❌ Initialization failed:', error);
                    const errorMessage =
                        "Hi! I'm having trouble loading my settings. Please make sure you have API key files (api-1.txt through api-5.txt) with your API keys. 💕";
                    girlfriend.addMessage(errorMessage, 'ai');
                }
            }, 1000);
            // Log system status
            setTimeout(() => {
                console.log('=== ENHANCED SYSTEM STATUS ===');
                console.log('Current Profile:', girlfriend.currentGirlName);
                console.log('Current Theme:', girlfriend.currentTheme);
                console.log('Available Themes:', themes.length);
                console.log('API Files Available:', girlfriend.apiLoader.apiFiles.length);
                console.log('jQuery loaded:', typeof $ !== 'undefined');
                console.log('ResponsiveVoice loaded:', typeof responsiveVoice !== 'undefined');
                console.log('Web Speech API available:', 'webkitSpeechRecognition' in window);
                console.log('Speech Synthesis available:', 'speechSynthesis' in window);
                console.log('API Loader initialized:', !!girlfriend.apiLoader);
                console.log('Call UI Features: ✅ Enhanced');
                console.log('Speech for Chat: ❌ Disabled');
                console.log('Speech for Calls: ✅ Enabled');
                console.log('===============================');
                console.log('\n=== DEVELOPER FUNCTIONS ===');
                console.log('testAPIKey() - Test random API key loading');
                console.log('testConversation(message) - Test chat conversation');
                console.log('testGeminiAPI() - Test Gemini API directly');
                console.log('testCall() - Test call functionality');
                console.log('simulateCallMessage(message) - Simulate call message');
                console.log('===========================');
            }, 1500);
        });
        // Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
    </script>
</body>

</html>
