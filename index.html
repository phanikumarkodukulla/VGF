<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VGF - Virtual Girl Friend</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=YOUR_RESPONSIVE_VOICE_KEY"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #e5ddd5;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Navbar */
        .chat-navbar {
            background:pink;
            color: black;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }

        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .profile-status {
            font-size: 12px;
            opacity: 0.8;
        }

        .navbar-actions {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-btn.in-call {
            color: #ff4757;
            animation: callPulse 2s infinite;
        }

        @keyframes callPulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Privacy Notice */
        .privacy-notice {
            background: #fff3cd;
            color: #856404;
            padding: 8px 16px;
            font-size: 12px;
            text-align: center;
            border-bottom: 1px solid #ffeaa7;
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
            background-size: contain;
            background-repeat: repeat;
            background-position: center;
        }

        .chat-messages.pink-theme {
            background-color: #ffeaa7;
        }

        .chat-messages.white-theme {
            background-color: #ffffff;
        }

        .chat-messages.black-theme {
            background-color: #2c2c2c;
            color: white;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message.user-message {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }

        .message.ai-message {
            flex-direction: row;
            justify-content: flex-start;
        }

        .message.system-message {
            justify-content: center;
        }

        .message-dp {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .message-content {
            max-width: 75%;
        }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .user-message .message-bubble {
            background: #dcf8c6;
            color: #303030;
        }

        .ai-message .message-bubble {
            background: white;
            color: #303030;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .black-theme .ai-message .message-bubble {
            background: #404040;
            color: white;
        }

        .system-message .message-bubble {
            background: #e1f5fe;
            color: #0277bd;
            font-style: italic;
            text-align: center;
            border-radius: 12px;
            padding: 6px 12px;
        }

        .message-time {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 4px;
            text-align: right;
        }

        .user-message .message-time {
            text-align: left;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
            margin-bottom: 16px;
            align-items: flex-end;
            gap: 8px;
        }

        .typing-dp {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .typing-bubble {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .black-theme .typing-bubble {
            background: #404040;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }

        /* Chat Input */
        .chat-input {
            padding: 8px 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 8px;
            align-items: flex-end;
           border-radius: 0 0 10px 10px;
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 16px;
            border: 3px solid #e0e0e0;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
            font-family: inherit;
            resize: none;
        }

        .message-input:focus {
            border-color:pink;
        }

        .input-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background:pink;
            color:black;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .input-btn:hover {
            background: #064e45;
        }

        .input-btn.listening {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Menu Popup */
        .menu-popup {
            position: absolute;
            top: 60px;
            right: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 200px;
            display: none;
        }

        .menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-item:hover {
            background: #f5f5f5;
        }

        .menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .menu-item i {
            color:pink;
            width: 20px;
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .profile-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }

        .profile-modal img {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 16px;
        }

        .profile-modal h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .close-btn {
            background: #075e54;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
        }

        /* Call Status */
        .call-status {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            display: none;
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            body {
                background: #d1c4b8;
            }
            
            .chat-container {
                height: 90vh;
                max-height: 700px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            }
            
            .chat-navbar {
                border-radius: 8px 8px 0 0;
            }
        }

        @media (max-width: 480px) {
            .chat-container {
                height: 100vh;
                max-width: 100%;
            }
            
            .profile-name {
                font-size: 14px;
            }
            
            .message-bubble {
                font-size: 14px;
            }
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Chat Navbar -->
        <div class="chat-navbar">
            <img id="profilePic" class="profile-pic" src="" alt="Profile">
            <div class="profile-info">
                <div id="profileName" class="profile-name">Loading...</div>
                <div id="profileStatus" class="profile-status">Online</div>
            </div>
            <div class="navbar-actions">
                <button id="callBtn" class="nav-btn" title="Start/End Call">
                    <i class="fas fa-phone" style = "color:black;"></i>
                </button>
                <button id="menuBtn" class="nav-btn" title="Menu">
                    <i class="fas fa-ellipsis-v" style = "color:black;"></i>
                </button>
            </div>
        </div>

        <!-- Menu Overlay -->
        <div id="menuOverlay" class="menu-overlay"></div>

        <!-- Menu Popup -->
        <div id="menuPopup" class="menu-popup">
            <div class="menu-item" id="viewProfile">
                <i class="fas fa-user"></i>
                <span>View Profile Picture</span>
            </div>
            <div class="menu-item" id="changeTheme">
                <i class="fas fa-palette"></i>
                <span>Change Chat Theme</span>
            </div>
            <div class="menu-item" id="changeGirlfriend">
                <i class="fas fa-sync-alt"></i>
                <span>Change Girlfriend</span>
            </div>
        </div>

        <!-- Privacy Notice -->
        <div class="privacy-notice">
            <i class="fas fa-lock"></i>
&nbsp; This chat is temporary and will not be saved due to privacy.
        </div>

        <!-- Call Status -->
        <div id="callStatus" class="call-status">üìû Call Status</div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-messages white-theme">
            <!-- Messages will be added here -->
        </div>

        <!-- Typing Indicator -->
        <div id="typingIndicator" class="typing-indicator">
            <img id="typingDp" class="typing-dp" src="" alt="Profile">
            <div class="typing-bubble">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="chat-input">
            <button id="voiceBtn" class="input-btn" title="Voice Input">
                <i class="fas fa-microphone"></i>
            </button>
            
            <input type="text" id="messageInput" class="message-input" placeholder="Type a message...">
            
            <button id="sendBtn" class="input-btn" title="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-modal-content">
            <img id="modalProfilePic" src="" alt="Profile Picture">
            <h3 id="modalProfileName">Profile</h3>
            <button class="close-btn" onclick="closeProfileModal()">Close</button>
        </div>
    </div>

    <script>
        // Random Data Arrays
        const girlImages = [
            'https://images.unsplash.com/photo-1494790108755-2616c056c6db?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1607746882042-944635dfe10e?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1580489944761-15a19d654956?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1544005313-94ddf0286df2?w=150&h=150&fit=crop&crop=face',
            'https://images.unsplash.com/photo-1506863530036-1efeddceb993?w=150&h=150&fit=crop&crop=face','img-2.jpg','img-3.jpeg','img-4.jpeg','img-5.png','img-6.png'
        ];

        const indianNames = [
            'Priya', 'Ananya', 'Kavya', 'Shreya', 'Isha', 'Riya', 'Aditi', 
            'Neha', 'Pooja', 'Sanya', 'Meera', 'Diya', 'Aisha', 'Kriti', 
            'Sakshi', 'Nisha', 'Tanya', 'Divya', 'Simran', 'Rhea'
        ];

        const boyIcon = 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face';

        const themes = ['pink-theme', 'white-theme', 'black-theme'];

        // Simple API Key Loader from TXT file
        class SimpleAPILoader {
            constructor() {
                this.apiKey = null;
                this.isLoaded = false;
                this.loadPromise = this.loadAPIKey();
            }

            async loadAPIKey() {
                try {
                    const response = await $.ajax({
                        url: 'api-key.txt',
                        type: 'GET',
                        dataType: 'text',
                        cache: false
                    });
                    
                    this.apiKey = response.trim();
                    this.isLoaded = true;
                    console.log('‚úÖ API key loaded successfully');
                    return this.apiKey;
                } catch (error) {
                    console.error('‚ùå Failed to load API key from api-key.txt:', error);
                    try {
                        const response = await $.ajax({
                            url: 'apikey.txt',
                            type: 'GET',
                            dataType: 'text',
                            cache: false
                        });
                        
                        this.apiKey = response.trim();
                        this.isLoaded = true;
                        console.log('‚úÖ API key loaded successfully from apikey.txt');
                        return this.apiKey;
                    } catch (error2) {
                        console.error('‚ùå Failed to load API key from both api-key.txt and apikey.txt');
                        throw new Error('API key file not found. Please create api-key.txt with your API key.');
                    }
                }
            }

            async getAPIKey() {
                if (this.isLoaded) {
                    return this.apiKey;
                }
                
                await this.loadPromise;
                return this.apiKey;
            }

            async waitForLoad() {
                await this.loadPromise;
                return this.isLoaded;
            }
        }

        // WhatsApp-style Virtual Girlfriend Class
        class WhatsAppGirlfriend {
            constructor() {
                this.apiLoader = new SimpleAPILoader();
                this.isSpeaking = false;
                this.isListening = false;
                this.isMuted = false;
                this.speechRate = 1.0;
                this.currentLanguage = 'en';
                this.conversationHistory = [];
                this.isInCall = false;
                this.callAutoResponse = true;
                this.currentTheme = 'white-theme';
                
                this.initializeRandomProfile();
                this.initializeComponents();
                this.setupEventListeners();
                this.initializeSpeechRecognition();
                this.initializeTextToSpeech();
            }

            initializeRandomProfile() {
                // Select random girl image and name
                this.currentGirlImage = girlImages[Math.floor(Math.random() * girlImages.length)];
                this.currentGirlName = indianNames[Math.floor(Math.random() * indianNames.length)];
                this.currentTheme = themes[Math.floor(Math.random() * themes.length)];
                
                // Set profile in DOM
                $('#profilePic').attr('src', this.currentGirlImage);
                $('#profileName').text(this.currentGirlName);
                $('#typingDp').attr('src', this.currentGirlImage);
                $('#chatMessages').removeClass().addClass('chat-messages ' + this.currentTheme);
            }

            initializeComponents() {
                this.chatMessages = $('#chatMessages');
                this.messageInput = $('#messageInput');
                this.sendBtn = $('#sendBtn');
                this.voiceBtn = $('#voiceBtn');
                this.callBtn = $('#callBtn');
                this.profileStatus = $('#profileStatus');
                this.typingIndicator = $('#typingIndicator');
                this.callStatus = $('#callStatus');
                this.menuBtn = $('#menuBtn');
                this.menuPopup = $('#menuPopup');
                this.menuOverlay = $('#menuOverlay');
            }

            setupEventListeners() {
                this.sendBtn.on('click', () => this.sendMessage());
                this.voiceBtn.on('click', () => this.toggleVoiceRecognition());
                this.callBtn.on('click', () => this.toggleCall());
                this.messageInput.on('keypress', (e) => {
                    if (e.which === 13 && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Menu functionality
                this.menuBtn.on('click', () => this.toggleMenu());
                this.menuOverlay.on('click', () => this.closeMenu());
                
                $('#viewProfile').on('click', () => this.viewProfile());
                $('#changeTheme').on('click', () => this.changeTheme());
                $('#changeGirlfriend').on('click', () => this.changeGirlfriend());
                
                // Profile picture click
                $('#profilePic').on('click', () => this.viewProfile());
            }

            toggleMenu() {
                if (this.menuPopup.is(':visible')) {
                    this.closeMenu();
                } else {
                    this.menuOverlay.show();
                    this.menuPopup.show();
                }
            }

            closeMenu() {
                this.menuOverlay.hide();
                this.menuPopup.hide();
            }

            viewProfile() {
                this.closeMenu();
                $('#modalProfilePic').attr('src', this.currentGirlImage);
                $('#modalProfileName').text(this.currentGirlName);
                $('#profileModal').show();
            }

            changeTheme() {
                this.closeMenu();
                // Get current theme index and move to next
                const currentIndex = themes.indexOf(this.currentTheme);
                const nextIndex = (currentIndex + 1) % themes.length;
                this.currentTheme = themes[nextIndex];
                
                this.chatMessages.removeClass().addClass('chat-messages ' + this.currentTheme);
                
                // Show confirmation message
                this.addMessage('Theme changed! ‚ú®', 'system');
            }

            changeGirlfriend() {
                this.closeMenu();
                // Reload page to get new random profile
                location.reload();
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.continuous = this.isInCall;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';

                    this.recognition.onstart = () => {
                        this.isListening = true;
                        this.voiceBtn.addClass('listening');
                        
                        if (this.isInCall) {
                            this.callStatus.text('üé§ Listening...');
                        } else {
                            this.profileStatus.text('Listening...');
                        }
                    };

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';
                        
                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }
                        
                        if (this.isInCall && interimTranscript) {
                            this.callStatus.text('üé§ ' + interimTranscript);
                        }
                        
                        if (finalTranscript) {
                            if (this.isInCall) {
                                this.handleCallMessage(finalTranscript);
                            } else {
                                this.messageInput.val(finalTranscript);
                                this.sendMessage();
                            }
                        }
                    };

                    this.recognition.onend = () => {
                        this.isListening = false;
                        this.voiceBtn.removeClass('listening');
                        
                        if (this.isInCall) {
                            this.callStatus.text('üìû In Call - Speak to chat');
                            setTimeout(() => {
                                if (this.isInCall && !this.isSpeaking) {
                                    this.startCallListening();
                                }
                            }, 500);
                        } else {
                            this.profileStatus.text('Online');
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        if (this.isInCall && event.error !== 'aborted') {
                            setTimeout(() => {
                                if (this.isInCall && !this.isListening) {
                                    this.startCallListening();
                                }
                            }, 1000);
                        }
                    };
                } else {
                    console.warn('Speech recognition not supported');
                }
            }

            initializeTextToSpeech() {
                this.synth = window.speechSynthesis;
                this.useResponsiveVoice = typeof responsiveVoice !== 'undefined';
                
                if (this.useResponsiveVoice) {
                    console.log('‚úÖ Using ResponsiveVoice for better speech quality');
                } else {
                    console.log('‚ö†Ô∏è ResponsiveVoice not available, using Web Speech API');
                }
            }

            toggleCall() {
                if (this.isInCall) {
                    this.endCall();
                } else {
                    this.startCall();
                }
            }

            startCall() {
                console.log('üìû Starting call...');
                this.isInCall = true;
                this.callBtn.addClass('in-call');
                this.callBtn.find('i').removeClass('fa-phone').addClass('fa-phone-slash');
                this.callStatus.show();
                this.callStatus.text('üìû Call Connected');
                this.profileStatus.text('On Call');
                
                this.addMessage('üìû Call started', 'system');
                
                setTimeout(() => {
                    const greeting = `Hi there! I'm ${this.currentGirlName}! So happy you called me! What's on your mind? üíï`;
                    this.addMessage(greeting, 'ai');
                    this.speakResponse(greeting, () => {
                        this.startCallListening();
                    });
                }, 1000);
            }

            endCall() {
                console.log('üìû Ending call...');
                this.isInCall = false;
                this.callBtn.removeClass('in-call');
                this.callBtn.find('i').removeClass('fa-phone-slash').addClass('fa-phone');
                this.callStatus.hide();
                this.profileStatus.text('Online');
                
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
                
                if (this.useResponsiveVoice) {
                    responsiveVoice.cancel();
                } else {
                    this.synth.cancel();
                }
                
                this.isSpeaking = false;
                
                this.addMessage('üìû Call ended', 'system');
                
                const goodbye = "Thanks for the lovely chat, honey! Call me anytime! üòò";
                this.addMessage(goodbye, 'ai');
            }

            startCallListening() {
                if (this.isInCall && !this.isListening && !this.isSpeaking && this.recognition) {
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.warn('Could not start speech recognition:', error);
                        setTimeout(() => {
                            if (this.isInCall && !this.isListening) {
                                this.startCallListening();
                            }
                        }, 1000);
                    }
                }
            }

            async handleCallMessage(message) {
                if (!message.trim()) return;
                
                console.log('Call message received:', message);
                this.addMessage(message, 'user');
                
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
                
                this.callStatus.text('ü§î Thinking...');
                
                try {
                    const response = await this.getAIResponse(message);
                    const cleanedResponse = this.cleanAPIResponse(response);
                    
                    this.addMessage(cleanedResponse, 'ai');
                    
                    this.speakResponse(cleanedResponse, () => {
                        if (this.isInCall) {
                            setTimeout(() => {
                                this.startCallListening();
                            }, 500);
                        }
                    });
                    
                } catch (error) {
                    console.error('Error in call conversation:', error);
                    
                    const errorResponse = "Sorry honey, I didn't catch that. Can you say it again? üíï";
                    this.addMessage(errorResponse, 'ai');
                    
                    this.speakResponse(errorResponse, () => {
                        if (this.isInCall) {
                            setTimeout(() => {
                                this.startCallListening();
                            }, 500);
                        }
                    });
                }
            }

            toggleVoiceRecognition() {
                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.recognition.start();
                }
            }

            async sendMessage() {
                const message = this.messageInput.val().trim();
                if (!message) return;

                this.addMessage(message, 'user');
                this.messageInput.val('');
                
                this.showTypingIndicator();
                
                try {
                    const response = await this.getAIResponse(message);
                    const cleanedResponse = this.cleanAPIResponse(response);
                    
                    setTimeout(() => {
                        this.hideTypingIndicator();
                        this.addMessage(cleanedResponse, 'ai');
                        this.speakResponse(cleanedResponse);
                    }, 1000 + Math.random() * 2000);
                    
                } catch (error) {
                    console.error('Error getting AI response:', error);
                    this.hideTypingIndicator();
                    this.addMessage("Sorry, I'm having trouble responding right now. Can you try again?", 'ai');
                }
            }

            addMessage(message, sender) {
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                let messageHtml = '';
                
                switch(sender) {
                    case 'user':
                        messageHtml = `
                            <div class="message user-message">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        ${message}
                                        <div class="message-time">${timestamp}</div>
                                    </div>
                                </div>
                                <img class="message-dp" src="${boyIcon}" alt="User">
                            </div>
                        `;
                        break;
                    case 'ai':
                        messageHtml = `
                            <div class="message ai-message">
                                <img class="message-dp" src="${this.currentGirlImage}" alt="AI">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        ${message}
                                        <div class="message-time">${timestamp}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                    case 'system':
                        messageHtml = `
                            <div class="message system-message">
                                <div class="message-content">
                                    <div class="message-bubble">
                                        ${message}
                                        <div class="message-time">${timestamp}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        break;
                }
                
                this.chatMessages.append(messageHtml);
                this.chatMessages.scrollTop(this.chatMessages[0].scrollHeight);
            }

            showTypingIndicator() {
                this.typingIndicator.show();
                this.chatMessages.scrollTop(this.chatMessages[0].scrollHeight);
            }

            hideTypingIndicator() {
                this.typingIndicator.hide();
            }

            cleanAPIResponse(response) {
                const cleaningPatterns = [
                    /google/gi, /gemini/gi, /openai/gi, /gpt/gi, /api/gi,
                    /artificial intelligence/gi, /machine learning/gi,
                    /language model/gi, /neural network/gi, /algorithm/gi
                ];
                
                let cleaned = response;
                cleaningPatterns.forEach(pattern => {
                    cleaned = cleaned.replace(pattern, '');
                });
                
                const cuteResponses = [
                    "üíï", "‚ù§Ô∏è", "üòä", "ü•∞", "üòò", "üíñ", "sweetie", "honey", 
                    "babe", "my love", "darling"
                ];
                
                if (Math.random() > 0.7) {
                    const randomCute = cuteResponses[Math.floor(Math.random() * cuteResponses.length)];
                    cleaned += ` ${randomCute}`;
                }
                
                return cleaned.trim();
            }

            async getAIResponse(message) {
                try {
                    const apiKey = await this.apiLoader.getAPIKey();
                    
                    if (!apiKey) {
                        throw new Error('API key not available');
                    }

                    const girlfriendPrompt = `You are ${this.currentGirlName}, a loving, caring, and sweet virtual girlfriend. You're playful, affectionate, and always supportive. You use cute emojis and pet names like "sweetie", "honey", "darling", "babe", etc. You care about your boyfriend's wellbeing, ask about his day, and make him feel special and loved. Keep responses relatively short and conversational. Be flirty but appropriate. You love talking on calls and chatting.

User message: ${message}

Respond as ${this.currentGirlName}, a caring girlfriend would:`;

                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + apiKey, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: girlfriendPrompt
                                }]
                            }],
                            generationConfig: {
                                temperature: 0.9,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 200,
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Invalid API response format');
                    }
                    
                } catch (error) {
                    console.error('AI Response Error:', error);
                    return this.getFallbackResponse(message);
                }
            }

            getFallbackResponse(message) {
                const lowerMessage = message.toLowerCase();
                
                if (lowerMessage.includes('love') || lowerMessage.includes('‚ù§Ô∏è')) {
                    const responses = [
                        "I love you too, sweetheart! You mean everything to me üíï",
                        "My heart beats for you, darling ‚ù§Ô∏è",
                        "You're the most amazing person in my life! ü•∞"
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                if (lowerMessage.includes('how are you')) {
                    const responses = [
                        "I'm doing great now that I'm talking to you, honey! üòä",
                        "Much better now that you're here, sweetie! üíï",
                        "Perfect, because I get to spend time with you! ‚ù§Ô∏è"
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                if (lowerMessage.includes('call') || this.isInCall) {
                    const responses = [
                        "I love hearing your voice, baby! üíï",
                        "This call makes me so happy, sweetie! üòä",
                        "Your voice is like music to me, honey! üéµ"
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                const defaultResponses = [
                    "That's so sweet of you to say! Tell me more, honey üíï",
                    "I'm here for you, darling. What's on your mind? ‚ù§Ô∏è",
                    "You always know how to make me smile, sweetie üòä",
                    "I love talking with you! You're amazing ü•∞",
                    "Your words always warm my heart, my love üíñ"
                ];
                
                return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            }

            speakResponse(text, callback = null) {
                if (this.isMuted) {
                    if (callback) callback();
                    return;
                }
                
                if (this.isSpeaking) {
                    if (this.useResponsiveVoice) {
                        responsiveVoice.cancel();
                    } else {
                        this.synth.cancel();
                    }
                }
                
                this.isSpeaking = true;
                
                const cleanText = text.replace(/[üòäü•∞üòòüíï‚ù§Ô∏èüíñüíùüçΩÔ∏èüò¥üìûüé§ü§îüéµ]/g, '').replace(/\*.*?\*/g, '');
                
                if (this.useResponsiveVoice) {
                    const voiceName = 'UK English Female';
                    
                    responsiveVoice.speak(cleanText, voiceName, {
                        pitch: 1.1,
                        rate: this.speechRate,
                        volume: 0.8,
                        onend: () => {
                            this.isSpeaking = false;
                            if (callback) callback();
                        },
                        onerror: () => {
                            console.warn('ResponsiveVoice error, falling back to Web Speech API');
                            this.speakWithWebSpeech(cleanText, callback);
                        }
                    });
                } else {
                    this.speakWithWebSpeech(cleanText, callback);
                }
            }

            speakWithWebSpeech(text, callback) {
                const utterance = new SpeechSynthesisUtterance(text);
                
                const voices = this.synth.getVoices();
                const femaleVoice = voices.find(voice => 
                    voice.name.includes('Female') || 
                    voice.name.includes('Samantha') || 
                    voice.name.includes('Karen') ||
                    voice.name.includes('Google UK English Female') ||
                    voice.name.includes('Microsoft Zira') ||
                    voice.gender === 'female'
                );
                
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                    console.log('Using voice:', femaleVoice.name);
                }
                
                utterance.rate = this.speechRate;
                utterance.pitch = 1.2;
                utterance.volume = 0.8;
                
                utterance.onend = () => {
                    this.isSpeaking = false;
                    if (callback) callback();
                };
                
                utterance.onerror = (error) => {
                    console.error('Speech synthesis error:', error);
                    this.isSpeaking = false;
                    if (callback) callback();
                };
                
                this.synth.speak(utterance);
            }
        }

        // Global functions for modal control
        function closeProfileModal() {
            $('#profileModal').hide();
        }

        // Initialize the application
        $(document).ready(function() {
            console.log('Initializing WhatsApp-style Virtual Girlfriend Application...');
            
            const girlfriend = new WhatsAppGirlfriend();
            
            // Developer functions
            window.testAPIKey = async function() {
                console.log('Testing API key loading...');
                try {
                    const apiKey = await girlfriend.apiLoader.getAPIKey();
                    console.log('API Key loaded:', apiKey ? '‚úÖ SUCCESS' : '‚ùå FAILED');
                    console.log('API Key length:', apiKey ? apiKey.length : 0);
                    console.log('API Key preview:', apiKey ? apiKey.substring(0, 10) + '...' : 'None');
                    return apiKey;
                } catch (error) {
                    console.error('API Key loading failed:', error);
                    return null;
                }
            };

            window.testCall = function() {
                console.log('=== TESTING CALL FUNCTIONALITY ===');
                
                if (!girlfriend.recognition) {
                    console.error('‚ùå Speech recognition not available');
                    return false;
                }
                
                if (girlfriend.isInCall) {
                    console.log('Ending current call...');
                    girlfriend.endCall();
                } else {
                    console.log('Starting test call...');
                    girlfriend.startCall();
                }
                
                return true;
            };
            
            window.simulateCallMessage = async function(message = "How are you doing today?") {
                if (!girlfriend.isInCall) {
                    console.log('Starting call first...');
                    girlfriend.startCall();
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                console.log('Simulating call message:', message);
                await girlfriend.handleCallMessage(message);
            };
            
            window.testConversation = async function(message = "How are you doing today?") {
                console.log('=== TESTING CONVERSATION ===');
                console.log('Message:', message);
                
                try {
                    const response = await girlfriend.getAIResponse(message);
                    console.log('Response:', response);
                    
                    girlfriend.addMessage(message, 'user');
                    girlfriend.addMessage(response, 'ai');
                    girlfriend.speakResponse(response);
                    
                    return response;
                } catch (error) {
                    console.error('Conversation test failed:', error);
                    return null;
                }
            };
            
            window.testGeminiAPI = async function() {
                console.log('=== TESTING GEMINI API ===');
                
                try {
                    const apiKey = await girlfriend.apiLoader.getAPIKey();
                    
                    if (!apiKey) {
                        console.error('‚ùå No API key available');
                        return false;
                    }
                    
                    console.log('Testing with API key:', apiKey.substring(0, 10) + '...');
                    
                    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + apiKey, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: "Just say 'Hello, API test successful!' and nothing else."
                                }]
                            }]
                        })
                    });
                    
                    console.log('API Response Status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('‚úÖ API test successful!');
                        console.log('Response:', data.candidates[0].content.parts[0].text);
                        return true;
                    } else {
                        const errorText = await response.text();
                        console.error('‚ùå API test failed:', response.status, errorText);
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå API test error:', error);
                    return false;
                }
            };
            
            // Initialize with welcome message
            setTimeout(async () => {
                try {
                    await girlfriend.apiLoader.waitForLoad();
                    
                    const initialMessage = `Hi there! I'm ${girlfriend.currentGirlName}, your virtual girlfriend! üíï You can chat with me normally or click the phone button to have a voice call! How are you doing today, sweetie? ü•∞`;
                    girlfriend.addMessage(initialMessage, 'ai');
                    
                    setTimeout(() => {
                        girlfriend.speakResponse(`Hi there! I'm ${girlfriend.currentGirlName}, your virtual girlfriend! You can chat with me normally or click the phone button to have a voice call! How are you doing today, sweetie?`);
                    }, 1000);
                    
                    console.log('‚úÖ WhatsApp-style virtual girlfriend initialized successfully!');
                } catch (error) {
                    console.error('‚ùå Initialization failed:', error);
                    
                    const errorMessage = "Hi! I'm having trouble loading my settings. Please make sure you have an 'api-key.txt' file with your API key. üíï";
                    girlfriend.addMessage(errorMessage, 'ai');
                }
            }, 1000);
            
            // Log system status
            setTimeout(() => {
                console.log('=== SYSTEM STATUS ===');
                console.log('Current Profile:', girlfriend.currentGirlName);
                console.log('Current Theme:', girlfriend.currentTheme);
                console.log('jQuery loaded:', typeof $ !== 'undefined');
                console.log('ResponsiveVoice loaded:', typeof responsiveVoice !== 'undefined');
                console.log('Web Speech API available:', 'webkitSpeechRecognition' in window);
                console.log('Speech Synthesis available:', 'speechSynthesis' in window);
                console.log('API Loader initialized:', !!girlfriend.apiLoader);
                console.log('===================');
                
                console.log('\n=== DEVELOPER FUNCTIONS ===');
                console.log('testAPIKey() - Test API key loading');
                console.log('testConversation(message) - Test full conversation');
                console.log('testGeminiAPI() - Test Gemini API directly');
                console.log('testCall() - Test call functionality');
                console.log('simulateCallMessage(message) - Simulate call message');
                console.log('===========================');
            }, 1500);
        });

        // Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
    </script>
</body>
</html>